---
title: "TURNOUT EXAMPLE Exploring the ANES Cumulative File (1948–2012)"
author: "A Person"
output: 
  html_document:
    keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE, include=TRUE, message=FALSE}
# Load packages ----
library(tidyverse)
library(haven)
library(gtsummary)  # For summary tables with survey objects
library(survey)
library(srvyr)
library(janitor)
library(sjlabelled)  # Can create tables with "nice" variable labels
library(knitr)
library(kableExtra)
library(margins)

# gtsummary: show N and %
theme_gtsummary_language("en")
```

## Read in the cumulative file

Read in the ANES Cumulative File (1948-2012) and create a survey object with weights.

```{r read_data, echo = FALSE, include=TRUE}
# Read the ANES cumulative SPSS file ----
# Make sure this .sav file is in your working directory or that you
# are pointing to the right directory
#
# The current script assumes it is being run from within the 
# "Final_Assignment_Voting_Models" folder, so the relative path to the data folder is used.
#
cumulative_nes <- read_sav("../data/ANES/anes_timeseries_cdf_spss_20220916.sav") %>%
  filter(VCF0004 %in% c(1952, 1956, 1960, 1964, 1968, # 1948 is messy
                        1972, 1976, 1980, 1984, 1988,
                        1992, 1996, 2000, 2004, 2008, 2012, 2016, 2020))

# Create a survey object using the post-election full-sample weight
# (VCF9999 is documented in the codebook as a post-election full-sample weight.)
cumulative_nes_weight <- cumulative_nes %>%
  filter(!is.na(VCF0009z)) %>%  # Survey design doesn't allow missing weights
  as_survey_design(
    ids = 1,          # no cluster variable; simple design for class
    weights = VCF0009z 
  )
```

## Create recoded variables

Create new variables indicating whether the respondent voted, whether they voted
for the Democratic candidate, and create a "democrat incumbent flipper" that you
can multiply by some issue positions to code them in a "democratic incumbent higher
scores liberal, republican incumbent higher scores conservative" way.

```{r recodes, echo = FALSE, include = TRUE}

cumulative_nes_weight_recode <- cumulative_nes_weight %>%
  mutate(
    voted = case_when(
      VCF0702 == 1 ~ 0,
      VCF0702 == 2 ~ 1),
    vote_democrat = case_when(
      VCF0704a == 1 ~ 1,
      VCF0704a == 2 ~ 0),
    democrat_incumbent_flipper = case_when(
      VCF0004 %in% c(1948, 1952, 1964, 1968, 1980, 1996, 2000, 2012, 2016) ~ 1,  #Dem Inc
      VCF0004 %in% c(1956, 1960, 1972, 1976, 1984, 1988, 1992, 2004, 2008, 2020) ~ -1), # GOP Inc
    pol377black = case_when(
      VCF0106 == 2 ~ 1,
      VCF0106 %in% c(1) ~ 0),
    pol377inc2 = case_when(
      VCF0114 == 2 ~ 1,
      VCF0114 %in% c(1,3,4,5) ~ 0),
    pol377inc3 = case_when(
      VCF0114 == 3 ~ 1,
      VCF0114 %in% c(1,2,4,5) ~ 0),
    pol377inc4 = case_when(
      VCF0114 == 4 ~ 1,
      VCF0114 %in% c(1,2,3,5) ~ 0),
    pol377inc5 = case_when(
      VCF0114 == 5 ~ 1,
      VCF0114 %in% c(1,2,3,4) ~ 0),
    )
    
```

## Turnout Over Time

Simple weighted tables and line chart showing the proportion of respondents who voted in each
election year 

```{r voting_over_time, echo = FALSE, include = TRUE}
# Proportion who voted by year ----

cumulative_nes_weight_recode %>%
  group_by(VCF0004) %>%
  summarize(
    prop_voted = survey_mean(voted, na.rm = TRUE)  # Note the diff using a factor
  ) %>%
  arrange(VCF0004) %>%
  mutate(
    prop_voted = scales::percent(prop_voted)
  ) %>%
  rename(
    Year = VCF0004,
    `Proportion Who Voted` = prop_voted
  ) %>%
  knitr::kable()

cumulative_nes_weight_recode %>%
  group_by(VCF0004) %>%
  summarize(
    prop_voted = survey_mean(voted, na.rm = TRUE)
  )%>%
  ggplot(., aes(x = VCF0004, y = prop_voted)) +
  geom_line() +
  geom_point(size = 2) +
  labs(
    title = "Estimated Turnout in ANES Presidential Years",
    x = "Year of ANES Study (VCF0004)",
    y = "Proportion Who Voted (survey-weighted)",
    caption = "Estimates use ANES cumulative file with survey weights."
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

## Leighley Nagler Replication Just for 1988

Compare the impact of race on turnout in 1988

```{r turnout_model, echo = TRUE, include = TRUE}

# Restrict survey design to individual years
anes1988 <- subset(cumulative_nes_weight_recode, VCF0004 == 1988) %>%
  mutate(age = as.numeric(VCF0101))   # Need to do this for the margins command to work at the end 


# OLS / Linear Probability Model for 1988
ols_1988 <- 
  svyglm(
    voted ~ pol377black + pol377inc2 + pol377inc3 + pol377inc4 + pol377inc5 + age,
    design = anes1988,
    family = gaussian()
  )

# Logistic Regression (Logit) for 1988
logit_1988 <- 
  svyglm(
    voted  ~ pol377black + pol377inc2 + pol377inc3 + pol377inc4 + pol377inc5 + age,
    design = anes1988,
    family = quasibinomial()
  )

# Display model summaries
summary(ols_1988)
margins(ols_1988)

summary(logit_1988)
margins(logit_1988)

m <- margins(logit_1988)

summary(m)

plot(m)

## Predicted turnout by age for a simple reference profile
newdat <- expand.grid(
  pol377black = 0,   # non-Black
  pol377inc2  = 0,   # baseline income category
  pol377inc3  = 0,
  pol377inc4  = 0,
  pol377inc5  = 0,
  age         = seq(18, 75, by = 1)
)

newdat$pred_p <- predict(logit_1988, newdata = newdat, type = "response")

ggplot(newdat, aes(x = age, y = pred_p)) +
  geom_line(size = 1.2) +
  labs(
    x = "Age",
    y = "Predicted Pr(voted)",
    title = "Predicted Probability of Turnout by Age\n(Reference: non-Black, baseline income)",
    caption = "Logit model, ANES 1988"
  ) +
  theme_minimal(base_size = 12)

# This is an alternative method. It creates a predicted probability for 
# every age for every observation, then averages these. This avoids setting the 
# predicted probabilities to unreasonable values. 

age_preds <- prediction(
  logit_1988,
  at   = list(age = 18:75),
  type = "response"
) %>%
  as.data.frame()

# Collapse to one average predicted probability per age
age_avg <- age_preds %>%
  group_by(age) %>%
  summarize(
    pred = mean(fitted, na.rm = TRUE)
  )

# Plot the *average* predicted probability by age
ggplot(age_avg, aes(x = age, y = pred)) +
  geom_line(size = 1.2) +
  labs(
    x = "Age",
    y = "Predicted probability of voting",
    title = "Predicted Turnout by Age (Average Adjusted Prediction)",
    caption = "Other variables averaged over their observed values"
  ) +
  theme_minimal(base_size = 13)

```

## Leighley Nagler Replication Figure 3.3 Impact of Black vs. White on Turnout 

Estimated using the ANES from 1972-2000

```{r race_marginal_effects_over_time, echo = TRUE, include = TRUE, message = FALSE, warning = FALSE}

# Years to include (presidential years in the cumulative file starting in 1972)
turnout_years <- c(1972, 1976, 1980, 1984, 1988,
                   1992, 1996, 2000, 2004, 2008,
                   2012, 2016, 2020)

# Empty data frame to store results
race_effects <- data.frame(
  year  = integer(),
  ame   = numeric(),   # Average Marginal Effect
  lower = numeric(),   # 95% CI lower
  upper = numeric()    # 95% CI upper
)

# Loop over years, estimate logit model and marginal effect of being Black
for (yr in turnout_years) {
  
  # Subset survey design to a single year
  anes_year <- subset(cumulative_nes_weight_recode, VCF0004 == yr) %>%
    # Make sure age is numeric for the model
    mutate(age = as.numeric(VCF0101),
           pol377black_f = factor(pol377black, levels = c(0, 1)) 
           )
  
  # Logistic regression for turnout in this year
  logit_year <- svyglm(
    voted ~ pol377black_f + pol377inc2 + pol377inc3 + pol377inc4 + pol377inc5 + age,
    design = anes_year,
    family = quasibinomial()
  )
  
  # Marginal effect of being Black (pol377black) on Pr(voted)
  # margins() gives us the average marginal effect and a standard error

  # This will calculate partial derivative and we actually want 0 and 1
  #  m_year  <- margins(logit_year, variables = "pol377black")
  # Try this instead
  m_year  <- margins(logit_year, variables="pol377black_f")
  sm_year <- summary(m_year)
  
  # Extract the AME and the 95% CI for this year
  race_effects <- rbind(
    race_effects,
    data.frame(
      year  = yr,
      ame   = sm_year$AME[1],
      lower = sm_year$lower[1],
      upper = sm_year$upper[1]
    )
  )
}

# Take a look at the results table (optional)
race_effects

# Plot: effect of being Black on probability of voting, 1972–2020
ggplot(race_effects, aes(x = year, y = ame)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Effect of Being Black on Turnout, 1972–2020",
    subtitle = "Average marginal effect from survey-weighted logit models",
    x = "Election Year",
    y = "Change in Probability of Voting (Black vs. non-Black)",
    caption = "Estimates based on ANES Cumulative File, survey-weighted svyglm + margins()"
  ) +
  theme_minimal(base_size = 12)

```
