---
title: "Exploring the ANES Cumulative File (1948â€“2012)"
author: "A Person"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE, include=TRUE, message=FALSE}
# Load packages ----
library(tidyverse)
library(haven)
library(gtsummary)  # For summary tables with survey objects
library(survey)
library(srvyr)
library(janitor)
library(sjlabelled)  # Can create tables with "nice" variable labels
library(knitr)
library(kableExtra)

# gtsummary: show N and %
theme_gtsummary_language("en")
```

## Read in the cumulative file

Read in the ANES Cumulative File (1948-2012) and create a survey object with weights.

```{r read_data, echo = FALSE, include=TRUE}
# Read the ANES cumulative SPSS file ----
# Make sure this .sav file is in your working directory or that you
# are pointing to the right directory
#
# The current script assumes it is being run from within the 
# "Final_Assignment_Voting_Models" folder, so the relative path to the data folder is used.
#
cumulative_nes <- read_sav("../data/ANES/anes_timeseries_cdf_spss_20220916.sav") %>%
  filter(VCF0004 %in% c(1948, 1952, 1956, 1960, 1964, 1968,
                        1972, 1976, 1980, 1984, 1988,
                        1992, 1996, 2000, 2004, 2008, 2012))

# Create a survey object using the post-election full-sample weight
# (VCF9999 is documented in the codebook as a post-election full-sample weight.)
cumulative_nes_weight <- cumulative_nes %>%
  filter(!is.na(VCF0009z)) %>%  # Survey design doesn't allow missing weights
  as_survey_design(
    ids = 1,          # no cluster variable; simple design for class
    weights = VCF0009z 
  )
```

## Explore the data

Simple display of the total number of respondents in the cumulative file for
each year. 

```{r explore_data}
# 1) Unweighted frequency table for VCF0004 (Year of Study) ----
cumulative_nes %>%
  tabyl(VCF0004)

# 2) Weighted table for VCF0004 using gtsummary::tbl_svysummary ----
cumulative_nes_weight %>%
  tbl_svysummary(
    include = VCF0004,
    type = VCF0004 ~ "categorical",
    statistic = all_categorical() ~ "{n} ({p}%)",
    label = VCF0004 ~ "Year of ANES Study"
  ) %>%
  modify_header(label ~ "**Variable**") |>
  bold_labels()
```

## Create recoded variables

Create new variables indicating whether the respondent voted, whether they voted
for the Democratic candidate, and create a "democrat incumbent flipper" that you
can multiply by some issue positions to code them in a "democratic incumbent higher
scores liberal, republican incumbent higher scores conservative" way.

```{r recodes, echo = FALSE, include = TRUE}

cumulative_nes_weight_recode <- cumulative_nes_weight %>%
  mutate(
    voted = case_when(
      VCF0702 == 1 ~ 0,
      VCF0704 == 2 ~ 1),
    vote_democrat = case_when(
      VCF0704a == 1 ~ 1,
      VCF0704a == 2 ~ 0),
    democrat_incumbent_flipper = case_when(
      VCF0004 %in% c(1948, 1952, 1964, 1968, 1980, 1996, 2000, 2012) ~ 1,
      VCF0004 %in% c(1956, 1960, 1972, 1976, 1984, 1988, 1992, 2004, 2008) ~ -1)
  )

```

## Turnout Over Time

Simple weighted tables and line chart showing the proportion of respondents who voted in each
election year 

```{r voting_over_time, echo = FALSE, include = TRUE}
# Proportion who voted by year ----

cumulative_nes_weight_recode %>%
  group_by(VCF0004) %>%
  summarize(
    prop_voted = survey_mean(voted, na.rm = TRUE)
  ) %>%
  arrange(VCF0004) %>%
  mutate(
    prop_voted = scales::percent(prop_voted)
  ) %>%
  rename(
    Year = VCF0004,
    `Proportion Who Voted` = prop_voted
  ) %>%
  knitr::kable()

cumulative_nes_weight_recode %>%
  group_by(VCF0004) %>%
  summarize(
    prop_voted = survey_mean(voted, na.rm = TRUE)
  )%>%
  ggplot(., aes(x = VCF0004, y = prop_voted)) +
  geom_line() +
  geom_point(size = 2) +
  labs(
    title = "Estimated Turnout in ANES Presidential Years",
    x = "Year of ANES Study (VCF0004)",
    y = "Proportion Who Voted (survey-weighted)",
    caption = "Estimates use ANES cumulative file with survey weights."
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

## The Simple Act

Look at the likes and dislikes of "The Simple Act" (VCF0322) over time.


```{r simple_act, echo = FALSE, include = TRUE}
# The Simple Act (VCF0322) over time ----

cumulative_nes_weight_recode %>%
  group_by(VCF0004) %>%
  summarize(
    mean_simple_act = survey_mean(VCF0322, na.rm = TRUE)
  ) %>%
  arrange(VCF0004) %>%
  mutate(
    mean_simple_act = round(mean_simple_act, 2)
  ) %>%
  rename(
    Year = VCF0004,
    `Mean Simple Act Score` = mean_simple_act
  ) %>%
  knitr::kable()

# The simple act by vote choice 

cumulative_nes_weight_recode %>%
  group_by(VCF0004, vote_democrat) %>%
  summarize(
    mean_simple_act = survey_mean(VCF0322, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(!is.na(vote_democrat)) %>%        # remove missing vote choice
  mutate(
    vote_choice = case_when(
      vote_democrat == 1 ~ "Voted Democrat",
      vote_democrat == 0 ~ "Voted Republican"
    ),
    mean_simple_act = round(mean_simple_act, 2)
  ) %>%
  select(Year = VCF0004, vote_choice, mean_simple_act) %>%
  pivot_wider(
    names_from = vote_choice,
    values_from = mean_simple_act
  ) %>%
  arrange(Year) %>%
  kable(
    caption = "Mean Simple Political Acts by Vote Choice (ANES Presidential Years)",
    col.names = c("Year", "Voted Democrat", "Voted Republican"),
    digits = 2,
    align = c("c", "c", "c")
  )

```
