---
title: "NEW PARTISAN VOTER Exploring the ANES Cumulative File (1948–2012)"
author: "A Person"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE, include=TRUE, message=FALSE}
# Load packages ----
library(tidyverse)
library(haven)
library(gtsummary)  # For summary tables with survey objects
library(survey)
library(srvyr)
library(janitor)
library(sjlabelled)  # Can create tables with "nice" variable labels
library(knitr)
library(kableExtra)
library(margins)

# gtsummary: show N and %
theme_gtsummary_language("en")
```

## Read in the cumulative file

Read in the ANES Cumulative File (1948-2012) and create a survey object with weights.

```{r read_data, echo = FALSE, include=TRUE}
# Read the ANES cumulative SPSS file ----
# Make sure this .sav file is in your working directory or that you
# are pointing to the right directory
#
# The current script assumes it is being run from within the 
# "Final_Assignment_Voting_Models" folder, so the relative path to the data folder is used.
#
cumulative_nes <- read_sav("../data/ANES/anes_timeseries_cdf_spss_20220916.sav") %>%  
  filter(VCF0004 %in% c( 1952, 1956, 1960, 1964, 1968,   # Not 1948 because party ID wasn't asked
                        1972, 1976, 1980, 1984, 1988,
                        1992, 1996, 2000, 2004, 2008, 2012, 2016, 2020))

# Create a survey object using the post-election full-sample weight
# (VCF9999 is documented in the codebook as a post-election full-sample weight.)
cumulative_nes_weight <- cumulative_nes %>%
  filter(!is.na(VCF0009z)) %>%  # Survey design doesn't allow missing weights
  as_survey_design(
    ids = 1,          # no cluster variable; simple design for class
    weights = VCF0009z 
  )
```

## Create recoded variables

Create new variables indicating whether the respondent voted, whether they voted
for the Democratic candidate, and create a "democrat incumbent flipper" that you
can multiply by some issue positions to code them in a "democratic incumbent higher
scores liberal, republican incumbent higher scores conservative" way.

```{r recodes, echo = FALSE, include = TRUE}

cumulative_nes_weight_recode <- cumulative_nes_weight %>%
  mutate(
    voted = case_when(
      VCF0702 == 1 ~ 0,
      VCF0702 == 2 ~ 1),
    vote_democrat = case_when(
      VCF0704a == 1 ~ 1,
      VCF0704a == 2 ~ 0),
    vote_republican = case_when(
      VCF0704a == 2 ~ 1,
      VCF0704a == 1 ~ 0),
    democrat_incumbent_flipper = case_when(
      VCF0004 %in% c(1948, 1952, 1964, 1968, 1980, 1996, 2000, 2012, 2016) ~ 1,  #Dem Inc
      VCF0004 %in% c(1956, 1960, 1972, 1976, 1984, 1988, 1992, 2004, 2008, 2020) ~ -1), # GOP Inc
    pol377black = case_when(
      VCF0106 == 2 ~ 1,
      VCF0106 %in% c(1) ~ 0),
    pol377inc2 = case_when(
      VCF0114 == 2 ~ 1,
      VCF0114 %in% c(1,3,4,5) ~ 0),
    pol377inc3 = case_when(
      VCF0114 == 3 ~ 1,
      VCF0114 %in% c(1,2,4,5) ~ 0),
    pol377inc4 = case_when(
      VCF0114 == 4 ~ 1,
      VCF0114 %in% c(1,2,3,5) ~ 0),
    pol377inc5 = case_when(
      VCF0114 == 5 ~ 1,
      VCF0114 %in% c(1,2,3,4) ~ 0),
    )
    
```

## Replicate Bafumi & Shapiro (2009) Figure 1

Standard deviation of the seven point party ID scale over time 

```{r bafumi_partyid_sd, echo = TRUE, include = TRUE, message = FALSE, warning = FALSE}

# Bafumi & Shapiro (2009) Figure:
# Standard deviation of 7-point Party ID (VCF0301) by presidential election year

# Note: VCF0301 = 1–7 Party ID scale
# Missing values are coded 0 or 9 in some years, which ANES documents as NIU.
# We drop values outside 1–7.

# Compute survey-weighted SD of 7-point party ID (VCF0301) by year
partyid_sd <- cumulative_nes_weight_recode %>%
  mutate(
    partyid = as.numeric(VCF0301),
    # Keep only valid 1–7 values; set everything else to NA
    partyid = if_else(partyid %in% 1:7, partyid, NA_real_)
  ) %>%
  group_by(VCF0004) %>%
  summarize(
    sd_weighted   = sqrt(survey_var(partyid, na.rm = TRUE)),
    sd_unweighted = sd(partyid, na.rm = TRUE),
    n             = sum(!is.na(partyid)),
    .groups = "drop"
  ) %>%
  rename(year = VCF0004)

# Take a look at the table
partyid_sd

# Plot in the style of Bafumi & Shapiro 2009
ggplot(partyid_sd, aes(x = year, y = sd_weighted)) +
  geom_point(size = 2) +
  geom_smooth(
    method = "loess",
    se = FALSE,
    span = 0.5,       # adjust smoothness (0.4–0.7 works well)
    size = 1.2
  ) +
  scale_x_continuous(breaks = seq(1952, 2020, by = 4)) +
  labs(
    title = "Standard Deviation of 7-Point Party Identification, 1952–2020",
    subtitle = "Replication and extension of Bafumi & Shapiro (2009) Figure 1",
    x = "Election Year",
    y = "Standard Deviation of Party ID (survey-weighted)",
    caption = "Computed from ANES Cumulative File using VCF0301 and VCF0009z survey weights"
  ) +
  theme_minimal(base_size = 13)

```

## Replicating Bafumi and Shapiro Figure 3 (partial)

```{r bafumi_fig3_partial, echo = TRUE, include = TRUE, message = FALSE, warning = FALSE}

# Years to include (same as before)
voting_years <- c(1952, 1956, 1960, 1964, 1968, 1972, 1976, 1980, 1984, 1988,
                   1992, 1996, 2000, 2004, 2008,
                   2012, 2016, 2020)

# Empty data frame to store coefficient paths over time
coef_time <- data.frame(
  year     = integer(),
  term     = character(),
  estimate = numeric(),
  se       = numeric(),
  lower    = numeric(),
  upper    = numeric(),
  stringsAsFactors = FALSE
)

for (yr in voting_years) {
  
  # Subset survey design to one year, and create needed predictors
  anes_year <- subset(cumulative_nes_weight_recode, VCF0004 == yr) %>%
    mutate(
      age   = as.numeric(VCF0101)/10,  # scale age to keep coefficients in a reasonable range
      age_sq = (age^2),  
      pid7  = as.numeric(VCF0301),
      pid7  = if_else(pid7 %in% 1:7, pid7, NA_real_),
      male  = case_when(
        VCF0104 == 1 ~ 1,   # 1 = male in ANES CDF
        VCF0104 == 2 ~ 0,   # 2 = female
        TRUE        ~ NA_real_
      ),
      south = case_when(
        VCF0113 == 1 ~ 1,  # South regions in ANES CDF
        VCF0113 == 2 ~ 0)
    )
  
  # Survey-weighted logit model for turnout
  logit_year <- svyglm(
    vote_republican ~ age + age_sq + pid7 + male + south,
    design = anes_year,
    family = quasibinomial()
  )
  
  # Extract coefficients and their variance-covariance matrix
  coefs <- coef(logit_year)
  vc    <- vcov(logit_year)
  
  # Variables of interest
  keep_terms <- c("age", "age_sq", "pid7", "male", "south")
  keep_terms <- keep_terms[keep_terms %in% names(coefs)]
  
  est <- coefs[keep_terms]
  se  <- sqrt(diag(vc)[keep_terms])
  
  # Build a small results data frame for this year
  tmp <- data.frame(
    year     = yr,
    term     = keep_terms,
    estimate = as.numeric(est),
    se       = as.numeric(se),
    stringsAsFactors = FALSE
  ) %>%
    mutate(
      lower = estimate - 1.96 * se,
      upper = estimate + 1.96 * se
    )
  
  coef_time <- rbind(coef_time, tmp)
}

# Nice labels for plotting
coef_time <- coef_time %>%
  mutate(
    term_label = dplyr::recode(
      term,
      age   = "Age",
      age_sq = "Age² (age^2 / 100)",
      pid7  = "Party ID (7-point)",
      male  = "Male (1) vs Female (0)",
      south = "South (1) vs. Non South (0)"
    )
  )

# Plot: logit coefficients over time, with 95% CIs
ggplot(coef_time, aes(x = year, y = estimate)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.6) +
  
  # --- NEW LOESS CURVE ---
  geom_smooth(
    method = "loess",
    se = FALSE,
    span = 0.75,        # adjust smoothing: smaller = wigglier, larger = smoother
    size = 1.1,
    color = "steelblue"
  ) +
  # ------------------------
  
  facet_wrap(~ term_label, scales = "free_y") +
  scale_x_continuous(breaks = turnout_years) +
  labs(
    title = "Logit Coefficients for Turnout, 1972–2020",
    subtitle = "Age, Age², Party ID, and Male (partial replication of Bafumi & Shapiro Figure 3)",
    x = "Election Year",
    y = "Logit coefficient (log-odds)",
    caption = "Survey-weighted svyglm models using ANES Cumulative File"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```


