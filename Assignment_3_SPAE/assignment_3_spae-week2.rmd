---
title: "Assignment_3_SPAE"
author: "Dr. Paul Gronke"
date: "`r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
```

## Step 1: Read in the SPAE 

1. The SPAE Report is available here https://electionlab.mit.edu/research/projects/survey-performance-american-elections
2. The SPAE Data are avaiable at Datavers https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/GWBAP5

I encourage you to learn how to download data yourself from dataverse, but for the purposes
of this lab, I have stored a Stata and SPSS version of the SPAE in the Assignment folder. 

To read the SPAE from either Stata or SPSS, you need to have the haven package. We will
also load the tidyverse package. 

Make sure you make the working directory so that it is "looking" in the "Assignment_3_SPAE" folder. 

```{r read_data}
library(tidyverse)
library(haven)
library(janitor) # creates nice tables using the tabyl command and supports piping
library(kableExtra)
library(scales)

# Read the SPAE data from Stata
spae_spss <- read_sav("../../data/SPAE/MITU0051_OUTPUT.sav")

```

## Step 3: Learn how to take advantage of SPSS labels using the "sjlabelled" package. 

You will want to install the "sjlabelled" package if it is not already installed.


```{r sjlabelled_tables}
library(sjlabelled)

table(as_label(spae_spss$Q1))
table(as_label(spae_spss$pid3))

# spae_spss %>%
#   tabyl(as_label(spae_spss$Q1))
# 
# spae_spss %>%
#   tabyl(as_label(spae_spss$pid3))

```


## Step 4: Learn how to use survey weights in R

R has a package called "survey" that allows you to use survey weights. There is also a
package called "srcvyr" that allows you to use the "dplyr" syntax with survey weights. 

Finally, there is a package called "gtsummary" that recognizes "survey weighted objects", 
which means you can make nice tables with survey weighted data.

You should install these if you do not already have them.

Documentation for using survey data in R is provided at https://tidy-survey-r.github.io/tidy-survey-book/


```{r survey_weighted_tables}
library(survey)
library(srvyr)
library(gtsummary)

# Do some recodes, theb convert all columns which are "labeled" as factors since these will display
# better in tables in R. 

spae_spss <- spae_spss %>%
  mutate(across(
    where(haven::is.labelled),
    ~ haven::as_factor(.x, levels = "labels")
    ) 
  ) %>%
  mutate(
    pid3 = fct_recode(pid3,
      "Independent" = "Independent",
      NULL = "Other",
      NULL = "Not sure",
      "Democrat"   = "Democrat",
      "Republican" = "Republican"),
    Q39 = case_when(
      Q39 == "I don't know" ~ NA,
      TRUE ~ Q39),
    Q42 = case_when(
      Q42 == "I don't know" ~ NA,
      TRUE ~ Q42),
    Q39_2 = case_when(
      Q39 %in% c("Very confident", "Somewhat confident") ~ "Confident",
      Q39 %in% c("Not too confident", "Not at all confident") ~ "Not confident",
      Q39 == "I don't know" ~ NA),
    Q42_2 = case_when(
      Q42 %in% c("Very confident", "Somewhat confident") ~ "Confident",
      Q42 %in% c("Not too confident", "Not at all confident") ~ "Not confident",
      Q42 == "I don't know" ~ NA)
    ) %>%
  mutate(across(where(is.factor), forcats::fct_drop))

# This alternative method converts only specific columns to factors

# spae_spss <- spae_spss %>%
#   mutate(
#     Q1   = haven::as_factor(Q1,   levels = "labels"),
#     pid3 = haven::as_factor(pid3, levels = "labels")
#   )

# Create a survey design object


spae_spss_design <- spae_spss %>%
  as_survey_design(weights = weight_final)

# Create a survey weighted table using gtsummary

# spae_spss_design %>%
#   tabyl(., Q1) 
#   
spae_spss_design %>%
  select(Q1) %>%
  tbl_svysummary(.)

spae_spss_design %>%
  select(pid3) %>%
  tbl_svysummary(.)

# Now show how you can do this in one pipe without creating a separate object

spae_spss_design %>% 
  tbl_svysummary(
    include = Q1,
    missing = "no") %>%
  modify_header(stat_0 ~ "**Voted**") %>%
  modify_caption("**Voting Turnout**") 

```


## Step 5: Create a table of voter confidence by Party ID

Examine the Voter Confidence items, calculate differences by PID


```{r voter_confidence_by_pid}

# Unweighted data.

spae_spss %>%
 tabyl(Q39)

spae_spss_design %>%
  filter(!is.na(pid3), !is.na(Q39)) %>%
  tbl_svysummary(include = Q39, by = pid3) %>%
  modify_header(label ~ "") %>%
  modify_caption("**Voter Confidence (own vote) by PID**")

spae_spss_design %>%
  filter(!is.na(pid3), !is.na(Q39)) %>%
  tbl_svysummary(include = Q39_2, by = pid3) %>%
  modify_header(label ~ "") %>%
  modify_caption("**Voter Confidence (own vote) by PID**")

spae_spss_design %>%
  filter(!is.na(pid3), !is.na(Q39)) %>%
  tbl_svysummary(include = Q42_2, by = pid3) %>%
  modify_header(label ~ "") %>%
  modify_caption("**Voter Confidence (national vote) by PID**")

spae_spss_design %>%
  filter(!is.na(pid3), !is.na(Q42_2)) %>%
  group_by(pid3, Q42_2) %>%
  summarize(pct = survey_mean(vartype = NULL, proportion = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = pid3, y = pct, fill = Q42_2)) +
  geom_col(position = "dodge") +   # stacked 100% bars
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Party ID (pid3)",
    y = "Percent",
    fill = "Confidence",
    title = "Voter Confidence (national vote) by Party ID"
  ) +
  theme_minimal()

```

## Voter confidence by states


```{r voter_confidence_by_state}
spae_spss_design %>%
  filter(!is.na(inputstate), !is.na(Q42_2)) %>%
  mutate(confident = Q42_2 == "Confident") %>%
  group_by(inputstate) %>%
  summarize(
    pct_confident = survey_mean(confident, vartype = NULL),  # This will only count the confident responses
    .groups = "drop"
  ) %>%
  mutate(`% Confident` = percent(pct_confident, accuracy = 0.1)) %>%
  select(inputstate, `% Confident`) %>%
  arrange(inputstate) %>% 
  kable(
    caption = "Voter Confidence (National Vote) by State",
    booktabs = TRUE,
    align = c("l", "r")
  ) %>%
  kable_styling(full_width = FALSE, latex_options = c("striped", "hold_position")) %>%
  footnote(
    general = "Source: 2024 Survey of the Performance of American Elections (SPAE)",
    threeparttable = TRUE
  )


 spae_spss_design %>%
  filter(!is.na(inputstate), !is.na(Q42_2)) %>%
  mutate(confident = Q42_2 == "Confident") %>%
  group_by(inputstate) %>%
  summarize(
    pct_confident = survey_mean(confident, vartype = NULL),  # This will only count the confident responses
    .groups = "drop"
  ) %>%
#  mutate(`% Confident` = percent(pct_confident, accuracy = 0.1)) %>%
  select(inputstate, pct_confident) %>%
   ggplot(aes(x = reorder(inputstate, pct_confident), y = pct_confident)) +
   geom_col(fill = "steelblue", width = 0.4) +
  scale_y_continuous(labels = scales::percent_format()) +
   labs(
     x = "State",
     y = "Percent Confident",
     title = "Voter Confidence (national vote) by State, 2024 SPAE"
   ) +
   theme_minimal() +
   coord_flip()


```
