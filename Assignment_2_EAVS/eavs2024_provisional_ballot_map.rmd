---
title: "EAVS 2024 – Provisional Ballot Usage"
author: "Paul Gronke"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, include=TRUE}
# Load libraries
library(tidyverse)
library(haven)
library(janitor)
library(maps)        # For state boundaries
library(ggplot2)     # For mapping

# Run the source script that loads the EAVS data into an object called `eavs`
source("eavs_read_simpler_version.r")
```

## Provisional Ballot Usage

```{r eavs-provisional-ballot-usage, echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}

# Calculate provisional usage by state
provisional_by_state <- eavs %>%
  group_by(state_full) %>%
  summarise(
    provisional_ballots = sum(f1e, na.rm = TRUE),  # Provisional ballots cast
    valid_ballots       = sum(f1a, na.rm = TRUE),  # Total voters
    .groups = "drop"
  ) %>%
  mutate(
    provisional_rate = (provisional_ballots / valid_ballots) * 100
  ) %>%
  arrange(state_full) %>%
  rename(State = state_full,
         `Provisional Ballots Cast` = provisional_ballots,
         `Valid Ballots Cast` = valid_ballots,
         `Provisional Usage (%)` = provisional_rate)

# Display the table
knitr::kable(
  provisional_by_state,
  caption = "Provisional Ballot Usage by State (EAVS 2024)",
  digits = 2
)


```

```{r eavs-provisional-ballot-usage2, echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}

# Calculate mail_in usage by state
vote_by_mail_state <- eavs %>%
  group_by(state_full) %>%
  summarise(
    vote_by_mail_state = sum(f1d, na.rm = TRUE),  # Provisional ballots cast
    valid_ballots       = sum(f1a, na.rm = TRUE),  # Total voters
    .groups = "drop"
  ) %>%
  mutate(
    mail_in_rate = (vote_by_mail_state / valid_ballots) * 100
  ) %>%
  arrange(state_full) %>%
  rename(State = state_full,
         `mail_in_ballots_cast` = provisional_ballots,
         `Valid Ballots Cast` = valid_ballots,
         `Provisional Usage (%)` = provisional_rate)

# Display the table
knitr::kable(
  provisional_by_state,
  caption = "Provisional Ballot Usage by State (EAVS 2024)",
  digits = 2
)


```

```{r eavs-provisional-ballot-map, echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}
# Get US states map data
us_states <- map_data("state")

# Prepare data for join (convert to lowercase state names)
provisional_map_data <- provisional_by_state %>%
  mutate(region = tolower(State))

# Join with map data
map_data_joined <- us_states %>%
  left_join(provisional_map_data, by = "region")

# Plot
ggplot(map_data_joined, aes(long, lat, group = group, fill = `Provisional Usage (%)`)) +
  geom_polygon(color = "white") +
  coord_fixed(1.3) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  labs(
    title = "Provisional Ballot Usage by State (EAVS 2024)",
    fill = "% of Valid Ballots Cast"
  ) +
  theme_minimal()

```

## Provisional Ballot Usage Rate – County Map

```{r provisional_county_map, echo=TRUE, include=TRUE}

# Step 1: Summarise provisional usage by county (jurisdiction)
provisional_by_county <- eavs %>%
  group_by(state_full, jurisdiction_name) %>%
  summarise(
    provisional_ballots = sum(f1e, na.rm = TRUE),
    valid_ballots       = sum(f1a, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    provisional_rate = (provisional_ballots / valid_ballots) * 100,
    region  = tolower(state_full),
    subregion = tolower(jurisdiction_name)
  )

# Step 2: Get US counties map
us_counties <- map_data("county")

# Step 3: Join map with data
map_county_joined <- us_counties %>%
  left_join(provisional_by_county, by = c("region", "subregion"))

# Step 4: Plot
ggplot(map_county_joined, aes(long, lat, group = group, fill = provisional_rate)) +
  geom_polygon(color = NA) +
  coord_fixed(1.3) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  labs(
    title = "Provisional Ballot Usage by County (EAVS 2024)",
    fill = "% of Valid Ballots"
  ) +
  theme_void()
```


## Provisional Ballot Usage – County (Jurisdiction) Map (FIPS-based)

```{r county_map_fips_safe, echo=TRUE, include=TRUE}
library(sf)
library(tigris)
library(stringr)
options(tigris_use_cache = TRUE)

# 1) Summarize by county FIPS with safe division
provisional_by_fips <- eavs %>%
  mutate(
    # Ensure 5-digit FIPS as characters (keep leading zeros)
    fips5 = case_when(
      is.na(fips_code) ~ NA_character_,
      TRUE ~ str_pad(as.character(fips_code), width = 5, side = "left", pad = "0")
    )
  ) %>%
  group_by(fips5) %>%
  summarise(
    provisional_ballots = sum(f1e, na.rm = TRUE),
    valid_ballots       = sum(f1a, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    provisional_rate = if_else(valid_ballots > 0,
                               100 * provisional_ballots / valid_ballots,
                               NA_real_)  # avoid Inf/NaN
  )

# 2) County shapes (drop territories)
counties_sf <- tigris::counties(cb = TRUE, class = "sf") %>%
  filter(!STATEFP %in% c("60","66","69","72","78"))  # AS, GU, MP, PR, VI

# 3) Join and project
county_map_data <- counties_sf %>%
  left_join(provisional_by_fips, by = c("GEOID" = "fips5"))

county_map_data_proj <- st_transform(county_map_data, 5070)

# 4) Compute a finite max for the legend; fall back if none
finite_max <- suppressWarnings(max(county_map_data_proj$provisional_rate, na.rm = TRUE))
use_limits <- is.finite(finite_max) && finite_max > 0

# 5) Optional visibility: print quick diagnostics to the console
message("Counties matched with data: ",
        sum(!is.na(county_map_data_proj$provisional_rate)), " of ",
        nrow(county_map_data_proj))

message("Any zero valid-ballot counties? ",
        any(provisional_by_fips$valid_ballots == 0, na.rm = TRUE))

# 6) Plot (conditionally apply limits)
p <- ggplot(county_map_data_proj) +
  geom_sf(aes(fill = provisional_rate), color = NA) +
  labs(
    title = "Provisional Ballot Usage by County (EAVS 2024)",
    subtitle = "Rate = (Provisional Ballots Cast ÷ Valid Ballots Cast) × 100",
    fill = "% Provisional",
    caption = "Source: EAVS 2024"
  ) +
  theme_void() +
  theme(legend.position = "right",
        plot.title = element_text(face = "bold"))

if (use_limits) {
  p <- p +
    scale_fill_viridis_c(
      option = "plasma",
      na.value = "grey90",
      limits = c(0, finite_max),
      labels = scales::label_number(accuracy = 0.1)
    )
} else {
  # Let ggplot pick breaks; still set palette and NA color
  p <- p +
    scale_fill_viridis_c(
      option = "plasma",
      na.value = "grey90",
      labels = scales::label_number(accuracy = 0.1)
    )
}

p
